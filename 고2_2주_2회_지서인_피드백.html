<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>고2_지서인 학생 · 내신 학습 지식맵 (2025-09-04)</title>
  <style>
    :root{
      --bg: #f6f7fb; --card:#ffffff; --border:#e6e8ef; --text:#0f172a; --muted:#64748b;
      --indigo:#4f46e5; --green:#16a34a; --yellow:#f59e0b; --red:#ef4444; --blue:#3b82f6;
      --green-100:#dcfce7; --yellow-100:#fef9c3; --red-100:#fee2e2; --gray-100:#f1f5f9; --blue-100:#dbeafe;
    }
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#ffffff, var(--bg, #f6f7fb));color:var(--text, #0f172a);font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Apple SD Gothic Neo,Pretendard,Helvetica,Arial,sans-serif}
    .container{max-width:1120px;margin:0 auto;padding:24px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
    .between{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .card{background:var(--card, #ffffff);border:1px solid var(--border, #e6e8ef);border-radius:20px;box-shadow:0 4px 12px rgba(15,23,42,.04)}
    .p-16{padding:16px}.p-20{padding:20px}.p-24{padding:24px}
    .btn{border:1px solid var(--border, #e6e8ef);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.active{background:var(--indigo, #4f46e5);color:#fff;border-color:var(--indigo, #4f46e5)}
    .input{border:1px solid var(--border, #e6e8ef);background:#fff;border-radius:12px;padding:10px 12px;min-width:260px}
    .grid{display:grid;gap:16px}
    @media(min-width:640px){.grid-2{grid-template-columns:repeat(2,minmax(0,1fr));}}
    @media(min-width:768px){.grid-3{grid-template-columns:repeat(3,minmax(0,1fr));}}
    .stat{min-width:240px}
    .hbar{height:8px;background:var(--gray-100, #f1f5f9);border-radius:999px;overflow:hidden}
    .hbar > span{display:block;height:100%}
    .pill{padding:3px 8px;border-radius:999px;font-size:11px;font-weight:700;display:inline-block}
    .legend .pill{border:1px solid var(--border, #e6e8ef);}
    .muted{color:var(--muted, #64748b)}
    .title{font-weight:800;letter-spacing:-.3px}
    .sub{font-size:12px}
    .kc-card{display:flex;gap:12px}
    .kc-ico{flex:0 0 auto;width:36px;height:36px;border-radius:12px;background:#f8fafc;display:grid;place-items:center;border:1px solid var(--border, #e6e8ef)}
    .small{font-size:12px}
    .type-card{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .kbd{font-variant-numeric:tabular-nums}
    .footer{font-size:12px;color:var(--muted, #64748b);display:flex;gap:8px;align-items:flex-start}
    .feedback-section h3 { font-size: 20px; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px; }
    .feedback-section h4 { font-size: 16px; margin: 24px 0 8px 0; color: var(--indigo, #4f46e5); border-left: 3px solid var(--indigo, #4f46e5); padding-left: 8px;}
    .feedback-section .summary { font-size: 14px; color: var(--muted, #64748b); margin-top: -12px; margin-bottom: 24px; }
    .feedback-section hr { border: 0; border-top: 1px solid var(--border, #e6e8ef); margin: 24px 0; }
    .feedback-section blockquote { margin: 12px 0; padding: 12px; background-color: var(--gray-100, #f1f5f9); border-left: 4px solid var(--border, #e6e8ef); border-radius: 8px; font-size: 13px; }
    .feedback-section .analysis { margin-top: 8px; }
    .feedback-section .analysis strong { color: var(--text, #0f172a); }
    @media print { #printBtn, .view-btn, #search {display:none} }
  </style>
</head>
<body>
  <div class="container">
    <div class="between" style="gap:16px;flex-wrap:wrap">
      <div>
        <div class="title" style="font-size:24px">영어II 3과 <span style="color:var(--indigo, #4f46e5)">KC & 유형 성취도</span> 대시보드</div>
        <div class="sub muted">학생: <strong>고2_지서인 학생</strong> · 시험일: <strong>2025-09-04</strong> · 교재: 능률(김성곤)</div>
      </div>
      <div class="row">
        <button id="printBtn" class="btn">내보내기/인쇄</button>
      </div>
    </div>

    <div class="row" style="margin-top:16px;align-items:center">
      <div class="row">
        <button data-view="all" class="btn view-btn active" aria-pressed="true">전체</button>
        <button data-view="core" class="btn view-btn" aria-pressed="false">기반</button>
        <button data-view="dialogue" class="btn view-btn" aria-pressed="false">대화문</button>
        <button data-view="reading" class="btn view-btn" aria-pressed="false">본문</button>
        <button data-view="types" class="btn view-btn" aria-pressed="false">문제 유형</button>
        <button data-view="feedback" class="btn view-btn" aria-pressed="false">피드백</button>
      </div>
      <div style="flex:1"></div>
      <input id="search" class="input" placeholder="KC 코드/이름/설명/유형 검색" />
    </div>

    <div class="grid grid-2" style="margin-top:16px">
      <div class="card p-16 stat">
        <div class="muted small">KC 평균 성취도</div>
        <div class="row" style="align-items:center;gap:6px">
          <div id="avgKC" class="title" style="font-size:22px;margin-top:4px">—</div>
          <div id="avgKCDiff" class="small" style="font-weight:700;"></div>
        </div>
        <div class="hbar" style="margin-top:8px"><span id="avgKCBar" style="width:0"></span></div>
      </div>
      <div class="card p-16 stat">
        <div class="muted small">문제 유형 평균 성취도</div>
        <div class="row" style="align-items:center;gap:6px">
          <div id="avgType" class="title" style="font-size:22px;margin-top:4px">—</div>
          <div id="avgTypeDiff" class="small" style="font-weight:700;"></div>
        </div>
        <div class="hbar" style="margin-top:8px"><span id="avgTypeBar" style="width:0"></span></div>
      </div>
    </div>

    <div class="legend row card p-16" style="margin-top:16px">
      <div class="muted small">범례:</div>
      <span class="pill" style="background:var(--green-100, #dcfce7);color:var(--green, #16a34a)">우수 ≥ 85%</span>
      <span class="pill" style="background:var(--yellow-100, #fef9c3);color:var(--yellow, #f59e0b)">60–84%</span>
      <span class="pill" style="background:var(--red-100, #fee2e2);color:var(--red, #ef4444)">1–59%</span>
      <span class="pill" style="background:#e5e7eb;color:#374151">미평가</span>
      <span class="pill" style="background:var(--blue-100, #dbeafe);color:var(--blue, #3b82f6)">NEW</span>
      <span class="muted small">▲▼ 이전 대비</span>
    </div>

    <div id="mount"></div>

    <section class="card p-20" style="margin-top:16px" id="focusBox">
      <div class="between">
        <div>
          <div class="title" style="font-size:18px">📌 집중 보완 영역 (상위 3개 KC)</div>
          <div class="sub muted">점수가 낮은 순으로 자동 추천</div>
        </div>
      </div>
      <ol id="focusList" class="small" style="margin-top:8px;padding-left:18px"></ol>
    </section>

    <div class="footer" style="margin-top:16px">
      <span>색상 기준: 🟢 85% 이상, 🟡 60–84%, 🟥 1–59%, 회색=미평가. 검색 또는 상단 버튼으로 뷰를 전환할 수 있습니다. 인쇄 버튼으로 PDF 저장 가능.</span>
    </div>
  </div>

  <script>
  (() => { 'use strict';
    // ======== 데이터(교체 대상) ========
    const studentName = "고2_지서인";
    const examDate = "2025-09-04";

    // --- 이전 성취도 ---
    const prevKcScores = { "KC-3D1": 100, "KC-3D2": 100, "KC-3G1": 70, "KC-3G2": 66.7, "KC-3R1": 92.7, "KC-3R2": 88.3, "KC-3R3": 70.9, "KC-3R4": 86.5, "KC-3R5": 93.9, "KC-3R6": 90.4, "KC-3R7": 94.7, "KC-3V1": 51.4 };
    const prevTypeScores = { "112": 100, "251": 50, "252": 60, "253": 88, "311": 100, "312": 95.2, "314": 100, "321": 83.3, "322": 83.3, "323": 100, "324": 100, "325": 0, "331": 100, "332": 40 };

    // --- 현재 성취도 ---
    const kcScores = { "KC-3D1": 100, "KC-3D2": 100, "KC-3G1": 70, "KC-3G2": 66.7, "KC-3R1": 95.3, "KC-3R2": 91.8, "KC-3R3": 81.2, "KC-3R4": 86.4, "KC-3R5": 93.4, "KC-3R6": 83.8, "KC-3R7": 95.6, "KC-3V1": 63.1 };
    const typeScores = [
      { code:"112", name:"대화 내용 일치/불일치", area:"대화", score:100, kcs:["KC-3D1","KC-3D2"]},
      { code:"251", name:"어법상 옳은/틀린 것", area:"문법", score:75, kcs:["KC-3R1","KC-3R2","KC-3R3","KC-3R4","KC-3R5"]},
      { code:"252", name:"쓰임 구분하기", area:"문법", score:60, kcs:["KC-3G1","KC-3G2"]},
      { code:"253", name:"빈칸에 적절한 것 고르기", area:"문법", score:88, kcs:["KC-3G1","KC-3G2"]},
      { code:"311", name:"글의 주제/제목 파악", area:"독해", score:100, kcs:["KC-3R1","KC-3R6","KC-3R7"]},
      { code:"312", name:"본문 내용 일치/불일치", area:"독해", score:94.6, kcs:["KC-3R1","KC-3R2","KC-3R3","KC-3R4","KC-3R5"]},
      { code:"314", name:"요약문 완성", area:"독해", score:86.4, kcs:["KC-3R2","KC-3R6","KC-3R7","KC-3V1"]},
      { code:"321", name:"문장 삽입/흐름", area:"독해", score:80, kcs:["KC-3R1","KC-3R3","KC-3R6","KC-3V1"]},
      { code:"322", name:"글의 순서 배열", area:"독해", score:87.5, kcs:["KC-3R1","KC-3R3"]},
      { code:"323", name:"이어질 내용 추론", area:"독해", score:100, kcs:[]},
      { code:"324", name:"지칭/의미 추론", area:"독해", score:100, kcs:[]},
      { code:"325", name:"본문 빈칸 추론", area:"독해", score:47.1, kcs:["KC-3R2","KC-3R3","KC-3R4","KC-3V1"]},
      { code:"331", name:"어휘 의미 파악", area:"어휘", score:100, kcs:["KC-3V1"]},
      { code:"332", name:"영영풀이", area:"어휘", score:50, kcs:["KC-3R4", "KC-3V1"]}
    ];

    // KC 메타
    const kcMeta = {
      "KC-3G1": { area: "문법", label: "재귀대명사의 강조용법", desc: "'스스로', '자체로' 의미 강조, 생략 가능" },
      "KC-3G2": { area: "문법", label: "접속사 whether", desc: "'~인지 아닌지' 의미의 명사절" },
      "KC-3V1": { area: "어휘", label: "통계/비판적 사고 어휘", desc: "statistics, sample, average, misleading 등" },
      "KC-3D1": { area: "대화문", label: "향수의 긍정적 효과", desc: "정신 건강, 자존감, 유대감에 미치는 영향" },
      "KC-3D2": { area: "대화문", label: "삶의 가치 설문조사", desc: "그래프 결과를 통한 가치관 파악" },
      "KC-3R1": { area: "본문", label: "통계의 역할과 위험성", desc: "일상 속 통계의 긍정적 역할과 악용 가능성" },
      "KC-3R2": { area: "본문", label: "표본의 크기 문제", desc: "적은 표본으로 인한 오해 유발 가능성" },
      "KC-3R3": { area: "본문", label: "표본의 무작위성 문제", desc: "자발적 응답 표본 추출의 편향성" },
      "KC-3R4": { area: "본문", label: "평균의 함정 소개", desc: "평균 종류에 따라 달라지는 해석" },
      "KC-3R5": { area: "본문", label: "다양한 종류의 평균", desc: "산술평균, 중앙값, 최빈값의 개념과 활용" },
      "KC-3R6": { area: "본문", label: "그래프 왜곡", desc: "세로축 조작을 통한 시각적 효과 왜곡" },
      "KC-3R7": { area: "본문", label: "비판적 시각의 중요성", desc: "통계 자료의 맹목적 수용 지양" }
    };

    const groups = [
      { id: "core", title: "A. 기반 지식", subtitle: "문법·어휘 기반", items:["KC-3G1","KC-3G2","KC-3V1"] },
      { id: "dialogue", title: "B-1. 적용 · 대화문", subtitle: "발표 및 설문조사 내용 이해", items:["KC-3D1","KC-3D2"] },
      { id: "reading", title: "B-2. 적용 · 본문", subtitle: "통계의 함정 비판적으로 읽기", items:["KC-3R1","KC-3R2","KC-3R3","KC-3R4","KC-3R5","KC-3R6","KC-3R7"] }
    ];

    // ======== 변화 계산 ========
    const kcChanges = Object.keys(kcScores).reduce((acc, key) => {
      const prev = prevKcScores[key];
      const curr = kcScores[key];
      acc[key] = { isNew: prev === undefined, diff: prev !== undefined ? curr - prev : 0 };
      return acc;
    }, {});
    const typeChanges = typeScores.reduce((acc, item) => {
      const prev = prevTypeScores[item.code];
      const curr = item.score;
      acc[item.code] = { isNew: prev === undefined, diff: prev !== undefined ? curr - prev : 0 };
      return acc;
    }, {});

    // ======== 헬퍼 ========
    const thresholds = { excellent:85, ok:60 };
    const clamp = (n) => Math.max(0, Math.min(100, Number(n||0)));
    function statusColor(v, bgOnly=false){
      if(v==null) return bgOnly? '#e5e7eb' : 'background:#e5e7eb;color:#374151';
      if(v>=thresholds.excellent) return bgOnly? 'var(--green-100, #dcfce7)' : 'background:var(--green-100, #dcfce7);color:var(--green, #16a34a)';
      if(v>=thresholds.ok) return bgOnly? 'var(--yellow-100, #fef9c3)' : 'background:var(--yellow-100, #fef9c3);color:var(--yellow, #f59e0b)';
      return bgOnly? 'var(--red-100, #fee2e2)' : 'background:var(--red-100, #fee2e2);color:var(--red, #ef4444)';
    }
    function barColor(v){
      if(v==null) return '#e5e7eb';
      if(v>=thresholds.excellent) return 'var(--green, #16a34a)';
      if(v>=thresholds.ok) return 'var(--yellow, #f59e0b)';
      return 'var(--red, #ef4444)';
    }
    function scoreLabel(v){ if(v==null) return '미평가'; const n=+v; return n===100 ? '100%' : n.toFixed(1)+'%'; }
    function average(nums){
      const vals = nums.filter(v => v!=null && !Number.isNaN(Number(v)));
      if(!vals.length) return null;
      return vals.reduce((a,b)=>a+Number(b),0)/vals.length;
    }

    function getFeedbackHTML(){
        return `
            <h3>📈 지서인 학생 학습 결과 분석</h3>
            <p class="summary" style="padding:12px; background-color: var(--gray-100, #f1f5f9); border-radius: 12px; font-size: 14px; margin-top:0;">
                지서인 학생은 <strong>글의 전체적인 흐름과 핵심 내용을 파악하는 독해 능력이 매우 뛰어납니다.</strong> 대부분의 본문 이해도(KC-3R 계열)와 내용 일치/불일치 유형(유형 312)에서 90%가 넘는 높은 성취도를 보이고 있어, 안정적인 기본기를 갖추고 있음을 알 수 있습니다.<br>
                다만, 현재의 탁월한 독해력을 만점으로 연결하기 위해 보완해야 할 <strong>결정적인 약점</strong>이 명확하게 나타나고 있습니다. 바로 <strong>'어휘의 정확한 의미'</strong>를 파악하고 문맥에 적용하는 능력입니다.
            </p>
            <hr>
            <h4>📌 약점 분석 1: 문맥 속 어휘 추론 능력 (유형 325: 47.1%)</h4>
            <p class="analysis">글의 맥락은 이해하지만, 빈칸에 들어갈 가장 적절한 단어를 고르거나, 쓰임이 어색한 단어를 찾아내는 데 어려움을 겪고 있습니다. 이는 <strong>통계 및 비판적 사고 관련 어휘(KC-3V1)</strong>에 대한 이해도가 63.1%로 상대적으로 낮은 것과 직접적인 관련이 있습니다.</p>
            <blockquote>
                <strong>🔍 대표 문제 예시 ([최다오답] 13번)</strong>
                <p style="margin-top:8px; margin-bottom:4px;"><strong>[지문]</strong> In the first graph, the <code>①horizontal</code> axis goes all the way up to 100 and all the way down to 0, which makes the decrease in the percentage look modest. In the other graph, only 10 percentage points are shown, from 65 to 75, which makes the change seem much more <code>③extreme</code>.</p>
                <p style="margin-top:4px; margin-bottom:4px;"><strong>[문제]</strong> 13. 다음 글의 밑줄 친 부분 중, 문맥상 어색한 단어를 고르시오.</p>
                <p style="margin-top:4px; margin-bottom:0;">➡️ <strong>정답: ①번</strong> / <strong>학생 답안: ③번</strong></p>
            </blockquote>
            <p class="analysis">
                <strong>분석:</strong> 지서인 학생은 변화가 급격해 보이도록 만드는 두 번째 그래프의 상황을 설명하는 'extreme(극적인)'이라는 단어가 어색하다고 판단했습니다. 하지만 이 단어는 문맥상 적절하게 사용되었습니다. <br>진짜 오류는 ①번 <strong>'horizontal(가로의)'</strong>이었습니다. 지문 속 그래프 1번에서 0부터 100까지의 수치를 나타내는 축은 <strong>'세로축(vertical axis)'</strong>입니다. 이처럼 'horizontal'과 'vertical' 같은 핵심 어휘의 의미를 정확히 알지 못해 발생한 실수입니다. 전체적인 내용은 이해했지만, 결정적인 단어 하나의 의미를 놓쳐 오답으로 이어진 대표적인 사례입니다.
            </p>

            <h4>📌 약점 분석 2: 세부 정보 해석의 정밀함</h4>
            <p class="analysis">전체적인 내용 파악 능력(유형 312: 94.6%)은 매우 우수하지만, 가끔 <strong>결정적인 단서나 표현을 놓쳐</strong> 아쉽게 틀리는 경우가 발생합니다. 이는 꼼꼼함과 정밀함을 조금 더 기르면 충분히 극복할 수 있는 부분입니다.</p>
            <blockquote>
                <strong>🔍 대표 문제 예시 1 ([최다빈출] 9번)</strong>
                <p style="margin-top:8px; margin-bottom:4px;"><strong>[지문]</strong> However, the fact is that more than half of its employees earn <code>no more than $30,000</code> or less a year...</p>
                <p style="margin-top:4px; margin-bottom:4px;"><strong>[문제]</strong> 9. 윗글의 내용과 일치하는 것을 고르시오.</p>
                <p style="margin-top:4px; margin-bottom:0;">➡️ <strong>정답: ①번</strong> / <strong>학생 답안: ②번</strong> "More than 50% of ABC corporation's employees get a bit more than $30,000."</p>
            </blockquote>
            <p class="analysis">
                <strong>분석:</strong> 학생이 고른 ②번 선택지는 '직원의 50% 이상이 30,000달러보다 약간 더 받는다'는 의미입니다. 하지만 지문에서는 <strong>'no more than $30,000'</strong>라고 명시되어 있습니다. 이는 <strong>'많아 봐야 30,000달러 (즉, 30,000달러 이하)'</strong>라는 뜻으로, 선택지의 내용과 정반대입니다. 'no more than'이라는 표현의 정확한 의미를 파악했다면 피할 수 있었던 아까운 실수입니다.
            </p>
        `;
    }

    // ======== 렌더 ========
    const mount = document.getElementById('mount');
    const searchEl = document.getElementById('search');
    const focusBox = document.getElementById('focusBox');
    let currentView = 'all';

    function render(){
      const q = (searchEl.value||'').trim().toLowerCase();
      mount.innerHTML = '';
      if(focusBox) focusBox.style.display = currentView === 'feedback' ? 'none' : 'block';

      ['core','dialogue','reading'].forEach(id=>{
        if(!(currentView==='all' || currentView===id)) return;
        const g = groups.find(x=>x.id===id);
        const items = g.items.filter(k=>{
          if(!q) return true;
          const m = kcMeta[k]||{};
          return k.toLowerCase().includes(q) || (m.label||'').toLowerCase().includes(q) || (m.desc||'').toLowerCase().includes(q) || (m.area||'').toLowerCase().includes(q);
        });
        if(!items.length) return;

        const sec = document.createElement('section');
        sec.className = 'card p-20';
        sec.style.marginTop = '16px';
        sec.innerHTML = `
          <div class="between">
            <div>
              <div class="title" style="font-size:18px">${id==='core'?'🧩':id==='dialogue'?'💬':'📖'} ${g.title}</div>
              <div class="sub muted">${g.subtitle}</div>
            </div>
          </div>
        `;
        const grid = document.createElement('div');
        grid.className = 'grid grid-2 grid-3';
        grid.style.marginTop = '12px';
        items.forEach(k => grid.appendChild(KCCard(k)));
        sec.appendChild(grid);
        mount.appendChild(sec);
      });

      if(currentView==='all' || currentView==='types'){
        const filteredTypes = typeScores.filter(t=>{
          if(!q) return true;
          return (t.name+t.code+t.area+(t.kcs||[]).join(',')).toLowerCase().includes(q);
        });
        if(filteredTypes.length){
          const sec = document.createElement('section');
          sec.className = 'card p-20';
          sec.style.marginTop = '16px';
          sec.innerHTML = `<div class="between"><div><div class="title" style="font-size:18px">📝 문제 유형 성취도</div><div class="sub muted">각 유형이 연계하는 KC와 성취도를 함께 확인</div></div></div>`;
          const grid = document.createElement('div');
          grid.className = 'grid grid-2';
          grid.style.marginTop = '12px';
          filteredTypes.forEach(t => grid.appendChild(TypeCard(t)));
          sec.appendChild(grid);
          mount.appendChild(sec);
        }
      }

      if(currentView==='all' || currentView==='feedback'){
        const sec = document.createElement('section');
        sec.className = 'card p-24 feedback-section';
        sec.style.marginTop = '16px';
        sec.innerHTML = getFeedbackHTML();
        mount.appendChild(sec);
      }

      const avgKCVal = average(Object.values(kcScores));
      const avgKCEl = document.getElementById('avgKC');
      if (avgKCEl) avgKCEl.textContent = scoreLabel(avgKCVal);
      const avgKCBarEl = document.getElementById('avgKCBar');
      if (avgKCBarEl) {
        avgKCBarEl.style.width = clamp(avgKCVal||0)+'%';
        avgKCBarEl.style.background = barColor(avgKCVal);
      }

      const prevKCAvgVal = average(Object.keys(kcScores).map(k => (prevKcScores.hasOwnProperty(k) ? prevKcScores[k] : null)));
      const kcDiffEl = document.getElementById('avgKCDiff');
      if(kcDiffEl) {
        if(prevKCAvgVal==null){
          kcDiffEl.innerHTML = `<span class="pill" style="background:var(--blue-100, #dbeafe);color:var(--blue, #3b82f6)">NEW</span>`;
        } else {
          const diff = (avgKCVal??0) - prevKCAvgVal;
          if(Math.abs(diff) > 0.05){
            const color = diff>0 ? 'var(--green, #16a34a)' : 'var(--red, #ef4444)';
            const arrow = diff>0 ? '▲' : '▼';
            kcDiffEl.innerHTML = `<span style="color:${color};font-variant-numeric:tabular-nums">${arrow}${Math.abs(diff).toFixed(1)}</span>`;
          } else {
            kcDiffEl.textContent = '';
          }
        }
      }

      const avgTypeVal = average(typeScores.map(t=>t.score));
      const avgTypeEl = document.getElementById('avgType');
      if (avgTypeEl) avgTypeEl.textContent = scoreLabel(avgTypeVal);
      const avgTypeBarEl = document.getElementById('avgTypeBar');
      if (avgTypeBarEl) {
        avgTypeBarEl.style.width = clamp(avgTypeVal||0)+'%';
        avgTypeBarEl.style.background = barColor(avgTypeVal);
      }
      
      const prevTypeAvgVal = average(typeScores.map(t => (prevTypeScores.hasOwnProperty(t.code) ? prevTypeScores[t.code] : null)));
      const typeDiffEl = document.getElementById('avgTypeDiff');
      if(typeDiffEl) {
        if(prevTypeAvgVal==null){
          typeDiffEl.innerHTML = `<span class="pill" style="background:var(--blue-100, #dbeafe);color:var(--blue, #3b82f6)">NEW</span>`;
        } else {
          const diff = (avgTypeVal??0) - prevTypeAvgVal;
          if(Math.abs(diff) > 0.05){
            const color = diff>0 ? 'var(--green, #16a34a)' : 'var(--red, #ef4444)';
            const arrow = diff>0 ? '▲' : '▼';
            typeDiffEl.innerHTML = `<span style="color:${color};font-variant-numeric:tabular-nums">${arrow}${Math.abs(diff).toFixed(1)}</span>`;
          } else {
            typeDiffEl.textContent = '';
          }
        }
      }
      renderFocus();
    }

    function KCCard(id){
      const m = kcMeta[id]||{}; const v = kcScores[id];
      const change = kcChanges[id] || { isNew:true, diff:0 };
      let changeHTML = '';
      if(change.isNew){
        changeHTML = `<span class="pill" style="background:var(--blue-100, #dbeafe); color:var(--blue, #3b82f6);">NEW</span>`;
      } else if(Math.abs(change.diff) > 0.05){
        const color = change.diff > 0 ? 'var(--green, #16a34a)' : 'var(--red, #ef4444)';
        const arrow = change.diff > 0 ? '▲' : '▼';
        changeHTML = `<span style="font-size:11px;font-weight:700;color:${color};">${arrow}${Math.abs(change.diff).toFixed(1)}</span>`;
      }

      const el = document.createElement('div');
      el.className = 'card p-16'; el.style.borderColor = '#e5e7eb';
      el.innerHTML = `
        <div class="kc-card">
          <div class="kc-ico">${m.area==='문법'?'✍️':m.area==='어휘'?'🔤':m.area==='대화문'?'💬':'📖'}</div>
          <div style="flex:1;min-width:0">
            <div class="row" style="align-items:center;gap:6px;flex-wrap:nowrap">
              <span class="small" style="font-weight:700;white-space:nowrap">${id}</span>
              <span class="pill" style="${statusColor(v)}">${scoreLabel(v)}</span>
              ${changeHTML}
            </div>
            <div class="small" style="font-weight:700;margin-top:4px">${m.label||''}</div>
            <div class="small muted" style="margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${m.desc||''}</div>
            <div class="hbar" style="margin-top:8px"><span style="width:${clamp(v||0)}%; background:${barColor(v)}"></span></div>
          </div>
        </div>
      `;
      return el;
    }

    function TypeCard(t){
      const change = typeChanges[t.code] || { isNew:true, diff:0 };
      let changeHTML = '';
      if(change.isNew){
        changeHTML = `<span class="pill" style="background:var(--blue-100, #dbeafe); color:var(--blue, #3b82f6); margin-left:4px;">NEW</span>`;
      } else if(Math.abs(change.diff) > 0.05){
        const color = change.diff > 0 ? 'var(--green, #16a34a)' : 'var(--red, #ef4444)';
        const arrow = change.diff > 0 ? '▲' : '▼';
        changeHTML = `<span style="font-size:12px;font-weight:700;color:${color};margin-left:4px;">${arrow}${Math.abs(change.diff).toFixed(1)}</span>`;
      }

      const el = document.createElement('div');
      el.className = 'card p-16';
      const related = (t.kcs||[]).map(k=>`${k} (${scoreLabel(kcScores[k])})`).join(' · ');
      el.innerHTML = `
        <div class="type-card">
          <div style="min-width:0">
            <div class="row" style="gap:6px;flex-wrap:wrap">
              <span class="small" style="font-weight:700">${t.name}</span>
              <span class="small muted">[${t.code}]</span>
              <span class="pill" style="background:#f3f4f6;color:#374151">${t.area}</span>
            </div>
            <div class="small muted" style="margin-top:4px">연계 KC: ${related}</div>
          </div>
          <div style="text-align:right;min-width:120px;flex-shrink:0;">
            <div class="row" style="justify-content:flex-end;gap:0;">
              <div style="font-weight:700">${scoreLabel(t.score)}</div>
              ${changeHTML}
            </div>
            <div class="hbar" style="margin-top:6px"><span style="width:${clamp(t.score||0)}%; background:${barColor(t.score)}"></span></div>
          </div>
        </div>
      `;
      return el;
    }

    function renderFocus(){
      const list = document.getElementById('focusList');
      if (!list) return;
      const entries = Object.entries(kcScores)
        .filter(([k,v])=>v!=null && v < thresholds.excellent)
        .sort((a,b)=> (a[1]-b[1]) || ((kcMeta[a[0]]?.area || '') > (kcMeta[b[0]]?.area || '') ? 1 : -1))
        .slice(0,3);

      const tips = {
        'KC-3V1': '통계 관련 어휘(random, sample 등)의 영영풀이를 확인하세요.',
        'KC-3G2': 'whether가 이끄는 명사절이 문장의 어느 위치에 쓰이는지 복습하세요.',
        'KC-3R3': '자발적 응답 표본 추출(voluntary response sampling)의 문제점을 정리해보세요.'
      };

      list.innerHTML = entries.map(([k,v])=>{
        const m = kcMeta[k]||{}; const tip = tips[k]||'핵심 개념 복습과 유사 문항 반복 연습을 권장합니다.';
        return `<li style="margin:6px 0"><strong>${k}</strong> (${m.label}) — <span class="pill" style="${statusColor(v)}">${scoreLabel(v)}</span><br><span class="muted">처방: ${tip}</span></li>`;
      }).join('') || '<li class="muted">집중 보완이 필요한 영역이 없습니다. 잘하고 있어요!</li>';
    }

    function init() {
        const printBtn = document.getElementById('printBtn');
        if (printBtn) printBtn.addEventListener('click', () => window.print());
        
        document.body.addEventListener('click', (e) => {
            const btn = e.target.closest('.view-btn');
            if (!btn) return;
            document.querySelectorAll('.view-btn').forEach(b => {
                b.classList.remove('active');
                b.setAttribute('aria-pressed', 'false');
            });
            btn.classList.add('active');
            btn.setAttribute('aria-pressed', 'true');
            currentView = btn.dataset.view || 'all';
            render();
        });

        if (searchEl) searchEl.addEventListener('input', render);
        render();
    }
    
    document.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>